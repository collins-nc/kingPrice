@using KingPrice.Abstraction
@using KingPrice.Abstraction.Dtos
@inject IUserApiClient UserApiClient

@if (isVisible)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingId == null ? "Add New User" : "Edit User")</h5>
                    <button type="button" class="btn-close" @onclick="Hide"></button>
                </div>
                
                <EditForm Model="@userModel" OnValidSubmit="Save">
                    <DataAnnotationsValidator />
                    
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">First Name</label>
                            <InputText class="form-control" @bind-Value="userModel.FirstName" />
                            <ValidationMessage For="@(() => userModel.FirstName)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Last Name</label>
                            <InputText class="form-control" @bind-Value="userModel.LastName" />
                            <ValidationMessage For="@(() => userModel.LastName)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Groups (comma separated)</label>
                            <InputText class="form-control" @bind-Value="groupString" placeholder="e.g. Sales, Marketing" />
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="Hide">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving) { <span class="spinner-border spinner-border-sm"></span> }
                            Save User
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public EventCallback OnSaved { get; set; }

    private bool isVisible;
    private bool isSaving;
    private int? editingId;
    private CreateUserRequest userModel = new();
    private string groupString = "";

    public void ShowCreate()
    {
        editingId = null;
        userModel = new CreateUserRequest();
        groupString = "";
        isVisible = true;
        StateHasChanged();
    }

    public void ShowEdit(UserResponse user)
    {
        editingId = user.Id;
        userModel = new CreateUserRequest 
        { 
            FirstName = user.FirstName, 
            LastName = user.LastName 
        };
        groupString = string.Join(", ", user.Groups.Select(g => g));
        isVisible = true;
        StateHasChanged();
    }

    public void Hide() => isVisible = false;

    // Step 2: Implement the missing Save method
    private async Task Save()
    {
        isSaving = true;
        try
        {
            // Convert comma-separated string to List<string>
            userModel.GroupNames = groupString
                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .ToList();

            if (editingId == null)
            {
                await UserApiClient.CreateUserAsync(userModel);
            }
            else
            {
                // Map CreateRequest to UpdateRequest logic
                var updateRequest = new UpdateUserRequest 
                { 
                    FirstName = userModel.FirstName, 
                    LastName = userModel.LastName, 
                    GroupNames = userModel.GroupNames 
                };
                await UserApiClient.UpdateUserAsync(editingId.Value, updateRequest);
            }

            await OnSaved.InvokeAsync();
            Hide();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving user: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
}